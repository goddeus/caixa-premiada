const axios = require('axios');

/**
 * SCRIPT DE TESTE PARA CREDITA√á√ÉO DE PR√äMIOS
 * 
 * Este script testa se os pr√™mios est√£o sendo creditados corretamente
 * tanto para contas demo quanto para contas normais.
 */

// Configura√ß√µes
const API_BASE = 'https://slotbox-api.onrender.com';

async function testPrizeCrediting() {
  try {
    console.log('üéØ Testando Credita√ß√£o de Pr√™mios...\n');
    
    // 1. Verificar se API est√° funcionando
    console.log('1. üîç Verificando API...');
    const healthResponse = await axios.get(`${API_BASE}/api/health`);
    console.log('‚úÖ API funcionando:', healthResponse.data.message);
    
    // 2. Criar conta demo de teste
    console.log('\n2. üë§ Criando conta demo de teste...');
    let demoAuthToken = '';
    let demoUser = null;
    
    try {
      const registerResponse = await axios.post(`${API_BASE}/api/auth/register`, {
        nome: 'Teste Credita√ß√£o Demo',
        email: `crediting.demo.${Date.now()}@teste.com`,
        senha: 'Demo123!',
        confirmarSenha: 'Demo123!',
        cpf: `demo${Date.now()}`
      });
      
      demoAuthToken = registerResponse.data.token;
      demoUser = registerResponse.data.user;
      console.log('‚úÖ Conta demo criada:', demoUser.nome);
      console.log(`   - Tipo: ${demoUser.tipo_conta}`);
      console.log(`   - Saldo Demo: R$ ${demoUser.saldo_demo || 0}`);
    } catch (error) {
      console.log('‚ö†Ô∏è Erro ao criar conta demo:', error.response?.data?.message);
      return;
    }
    
    // 3. Criar conta normal para compara√ß√£o
    console.log('\n3. üë§ Criando conta normal para compara√ß√£o...');
    let normalAuthToken = '';
    let normalUser = null;
    
    try {
      const registerResponse = await axios.post(`${API_BASE}/api/auth/register`, {
        nome: 'Teste Credita√ß√£o Normal',
        email: `crediting.normal.${Date.now()}@teste.com`,
        senha: 'Normal123!',
        confirmarSenha: 'Normal123!',
        cpf: `normal${Date.now()}`
      });
      
      normalAuthToken = registerResponse.data.token;
      normalUser = registerResponse.data.user;
      console.log('‚úÖ Conta normal criada:', normalUser.nome);
      console.log(`   - Tipo: ${normalUser.tipo_conta}`);
      console.log(`   - Saldo: R$ ${normalUser.saldo_reais || 0}`);
    } catch (error) {
      console.log('‚ö†Ô∏è Erro ao criar conta normal:', error.response?.data?.message);
      return;
    }
    
    // 4. Obter caixas dispon√≠veis
    console.log('\n4. üì¶ Obtendo caixas dispon√≠veis...');
    const casesResponse = await axios.get(`${API_BASE}/api/cases`, {
      headers: { Authorization: `Bearer ${demoAuthToken}` }
    });
    const cases = casesResponse.data.data || casesResponse.data;
    console.log(`‚úÖ ${cases.length} caixas encontradas`);
    
    if (cases.length === 0) {
      console.log('‚ùå Nenhuma caixa dispon√≠vel para teste');
      return;
    }
    
    const testCase = cases[0];
    console.log(`üì¶ Testando caixa: ${testCase.nome} (R$ ${testCase.preco})`);
    
    // 5. Testar credita√ß√£o em conta demo
    console.log('\n5. üéØ Testando CREDITA√á√ÉO em CONTA DEMO...');
    const demoResults = [];
    
    for (let i = 1; i <= 3; i++) {
      try {
        console.log(`   Teste ${i}/3...`);
        
        // Obter saldo antes
        const balanceBeforeResponse = await axios.get(`${API_BASE}/api/user/balance`, {
          headers: { Authorization: `Bearer ${demoAuthToken}` }
        });
        const balanceBefore = balanceBeforeResponse.data.saldo_demo || 0;
        
        // Comprar caixa
        const buyResponse = await axios.post(
          `${API_BASE}/api/cases/${testCase.id}/buy`,
          {},
          {
            headers: { Authorization: `Bearer ${demoAuthToken}` }
          }
        );
        
        const result = buyResponse.data;
        
        // Obter saldo depois
        const balanceAfterResponse = await axios.get(`${API_BASE}/api/user/balance`, {
          headers: { Authorization: `Bearer ${demoAuthToken}` }
        });
        const balanceAfter = balanceAfterResponse.data.saldo_demo || 0;
        
        // Calcular diferen√ßa real
        const actualDifference = balanceAfter - balanceBefore;
        const expectedDifference = result.prize.valor - testCase.preco;
        
        demoResults.push({
          prize: result.prize.nome,
          prizeValue: result.prize.valor,
          casePrice: testCase.preco,
          balanceBefore: balanceBefore,
          balanceAfter: balanceAfter,
          expectedDifference: expectedDifference,
          actualDifference: actualDifference,
          isCorrect: Math.abs(actualDifference - expectedDifference) < 0.01
        });
        
        console.log(`     Pr√™mio: ${result.prize.nome} - R$ ${result.prize.valor}`);
        console.log(`     Saldo antes: R$ ${balanceBefore.toFixed(2)}`);
        console.log(`     Saldo depois: R$ ${balanceAfter.toFixed(2)}`);
        console.log(`     Diferen√ßa esperada: R$ ${expectedDifference.toFixed(2)}`);
        console.log(`     Diferen√ßa real: R$ ${actualDifference.toFixed(2)}`);
        console.log(`     ‚úÖ Credita√ß√£o correta: ${Math.abs(actualDifference - expectedDifference) < 0.01 ? 'SIM' : 'N√ÉO'}`);
        
      } catch (error) {
        console.log(`     ‚ùå Erro no teste ${i}:`, error.response?.data?.message);
      }
    }
    
    // 6. Testar credita√ß√£o em conta normal
    console.log('\n6. üéØ Testando CREDITA√á√ÉO em CONTA NORMAL...');
    const normalResults = [];
    
    for (let i = 1; i <= 3; i++) {
      try {
        console.log(`   Teste ${i}/3...`);
        
        // Obter saldo antes
        const balanceBeforeResponse = await axios.get(`${API_BASE}/api/user/balance`, {
          headers: { Authorization: `Bearer ${normalAuthToken}` }
        });
        const balanceBefore = balanceBeforeResponse.data.saldo_reais || 0;
        
        // Comprar caixa
        const buyResponse = await axios.post(
          `${API_BASE}/api/cases/${testCase.id}/buy`,
          {},
          {
            headers: { Authorization: `Bearer ${normalAuthToken}` }
          }
        );
        
        const result = buyResponse.data;
        
        // Obter saldo depois
        const balanceAfterResponse = await axios.get(`${API_BASE}/api/user/balance`, {
          headers: { Authorization: `Bearer ${normalAuthToken}` }
        });
        const balanceAfter = balanceAfterResponse.data.saldo_reais || 0;
        
        // Calcular diferen√ßa real
        const actualDifference = balanceAfter - balanceBefore;
        const expectedDifference = result.prize.valor - testCase.preco;
        
        normalResults.push({
          prize: result.prize.nome,
          prizeValue: result.prize.valor,
          casePrice: testCase.preco,
          balanceBefore: balanceBefore,
          balanceAfter: balanceAfter,
          expectedDifference: expectedDifference,
          actualDifference: actualDifference,
          isCorrect: Math.abs(actualDifference - expectedDifference) < 0.01
        });
        
        console.log(`     Pr√™mio: ${result.prize.nome} - R$ ${result.prize.valor}`);
        console.log(`     Saldo antes: R$ ${balanceBefore.toFixed(2)}`);
        console.log(`     Saldo depois: R$ ${balanceAfter.toFixed(2)}`);
        console.log(`     Diferen√ßa esperada: R$ ${expectedDifference.toFixed(2)}`);
        console.log(`     Diferen√ßa real: R$ ${actualDifference.toFixed(2)}`);
        console.log(`     ‚úÖ Credita√ß√£o correta: ${Math.abs(actualDifference - expectedDifference) < 0.01 ? 'SIM' : 'N√ÉO'}`);
        
      } catch (error) {
        console.log(`     ‚ùå Erro no teste ${i}:`, error.response?.data?.message);
      }
    }
    
    // 7. An√°lise dos resultados
    console.log('\n7. üìä AN√ÅLISE DA CREDITA√á√ÉO:');
    
    // An√°lise conta demo
    const demoCorrectCredits = demoResults.filter(r => r.isCorrect).length;
    const demoTotalPrizes = demoResults.reduce((sum, r) => sum + r.prizeValue, 0);
    const demoTotalSpent = demoResults.length * testCase.preco;
    
    console.log('\nüéØ CONTA DEMO:');
    console.log(`   - Credita√ß√µes corretas: ${demoCorrectCredits}/${demoResults.length} (${(demoCorrectCredits/demoResults.length*100).toFixed(1)}%)`);
    console.log(`   - Total gasto: R$ ${demoTotalSpent.toFixed(2)}`);
    console.log(`   - Total ganho: R$ ${demoTotalPrizes.toFixed(2)}`);
    console.log(`   - Saldo l√≠quido: R$ ${(demoTotalPrizes - demoTotalSpent).toFixed(2)}`);
    
    // An√°lise conta normal
    const normalCorrectCredits = normalResults.filter(r => r.isCorrect).length;
    const normalTotalPrizes = normalResults.reduce((sum, r) => sum + r.prizeValue, 0);
    const normalTotalSpent = normalResults.length * testCase.preco;
    
    console.log('\nüë§ CONTA NORMAL:');
    console.log(`   - Credita√ß√µes corretas: ${normalCorrectCredits}/${normalResults.length} (${(normalCorrectCredits/normalResults.length*100).toFixed(1)}%)`);
    console.log(`   - Total gasto: R$ ${normalTotalSpent.toFixed(2)}`);
    console.log(`   - Total ganho: R$ ${normalTotalPrizes.toFixed(2)}`);
    console.log(`   - Saldo l√≠quido: R$ ${(normalTotalPrizes - normalTotalSpent).toFixed(2)}`);
    
    // Verifica√ß√£o se est√° funcionando
    console.log('\n‚úÖ VERIFICA√á√ÉO DA CREDITA√á√ÉO:');
    if (demoCorrectCredits === demoResults.length) {
      console.log('   ‚úÖ Contas demo: Credita√ß√£o funcionando perfeitamente');
    } else {
      console.log('   ‚ùå Contas demo: Problemas na credita√ß√£o detectados');
    }
    
    if (normalCorrectCredits === normalResults.length) {
      console.log('   ‚úÖ Contas normais: Credita√ß√£o funcionando perfeitamente');
    } else {
      console.log('   ‚ùå Contas normais: Problemas na credita√ß√£o detectados');
    }
    
    // Verificar se contas demo ganham mais
    const demoNetGain = demoTotalPrizes - demoTotalSpent;
    const normalNetGain = normalTotalPrizes - normalTotalSpent;
    
    if (demoNetGain > normalNetGain) {
      console.log('   ‚úÖ Contas demo ganham mais que contas normais (RTP alto funcionando)');
    } else {
      console.log('   ‚ùå Contas demo N√ÉO ganham mais que contas normais (RTP pode estar igual)');
    }
    
    console.log('\nüéØ TESTE DE CREDITA√á√ÉO CONCLU√çDO!');
    console.log('üí° Verifique se os pr√™mios est√£o sendo creditados corretamente no saldo.');
    
  } catch (error) {
    console.error('‚ùå Erro no teste:', error.message);
    if (error.response) {
      console.error('üì° Status:', error.response.status);
      console.error('üì° Data:', error.response.data);
    }
  }
}

// Executar teste
testPrizeCrediting();
